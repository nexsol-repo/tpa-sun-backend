name: CI/CD - TPA Sun Backend

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: tpa-sun-backend
  DEPLOY_PATH: /home/nex3/app/tpa-sun-backend

jobs:
  build-and-deploy:
    runs-on: self-hosted # 태그가 있다면 [self-hosted, sun] 등으로 변경

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # 로컬 Docker 데몬 드라이버 사용 (이미지를 로컬에 저장)
          driver: docker

      - name: Set Environment Variables based on Branch
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "TARGET_ENV=prod" >> $GITHUB_ENV
            echo "Target Environment: PROD (Main)"
          else
            echo "TARGET_ENV=dev" >> $GITHUB_ENV
            echo "Target Environment: DEV"
          fi

      - name: Build Docker Image Locally
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true # 빌드된 이미지를 로컬 Docker 데몬으로 로드
          tags: ${{ env.IMAGE_NAME }}:${{ env.TARGET_ENV }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # --- 배포(CD) 단계 ---

      - name: Prepare Deployment Directory
        run: |
          mkdir -p ${{ env.DEPLOY_PATH }}
          # 설정 파일 및 스크립트 복사
          cp docker-compose.deploy.yml ${{ env.DEPLOY_PATH }}/
          cp scripts/deploy.sh ${{ env.DEPLOY_PATH }}/
          chmod +x ${{ env.DEPLOY_PATH }}/deploy.sh

      - name: Execute Deployment Script
        working-directory: ${{ env.DEPLOY_PATH }}
        env:
          # 빌드된 이미지 태그를 환경변수로 주입 (deploy.sh 내부 docker-compose가 사용)
          DOCKER_IMAGE: ${{ env.IMAGE_NAME }}:${{ env.TARGET_ENV }}
        run: |
          # 환경(dev/prod)을 인자로 전달하여 스크립트 실행
          ./deploy.sh ${{ env.TARGET_ENV }}

      - name: Cleanup Docker System
        run: |
          docker image prune -f