services:
  app:
    # 이미지 이름은 환경변수로 주입받음 (deploy.sh 또는 .env)
    image: ${DOCKER_IMAGE}
    restart: always
    # 실행 시점에 지정된 .env 파일을 로드
    env_file:
      - .env
    ports:
      # 호스트의 특정 포트(8081, 8082 등)를 컨테이너 8080에 연결
      - "127.0.0.1:${HOST_PORT}:8080"
    environment:
      - TZ=Asia/Seoul
      - SERVER_PORT=8080
      # 외부 .env 파일에서 로드된 값을 컨테이너 내부로 전달
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      # DB_HOST는 이제 'nex4'라는 호스트 이름을 사용합니다.
      # 이 이름은 아래 extra_hosts 설정에 의해 실제 IP로 연결됩니다.
      - DB_HOST=nex4
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - GMAIL_EMAIL=${GMAIL_EMAIL}
      - GMAIL_PASSWORD=${GMAIL_PASSWORD}
      - MINIO_URL=${MINIO_URL}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    # 외부 서버(nex4) DB 접속을 위한 호스트 매핑
    # DB_HOST_IP 변수는 .env 파일에 정의되어 있어야 합니다.
    extra_hosts:
      - "nex4:${DB_HOST_IP}"